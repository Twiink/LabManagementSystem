# 智能实验室预约与设备管理系统 数据库设计文档

> 基于后端设计文档落地的 MySQL 8.x 数据库设计草案，强调字段类型、约束、索引与关系。

## 1. 设计原则与约定
- 数据库：MySQL 8.x，InnoDB。
- 时间：统一 UTC 入库与计算，前端展示转本地时区；精度到分钟。
- 主键：BIGINT 自增。
- 状态字段：使用 VARCHAR/ENUM（本文用 VARCHAR 标注，便于迁移）。
- 软删除：统一使用 is_deleted 字段（0/1），业务查询默认过滤 is_deleted=0。
- 规范：created_at/updated_at 统一维护。

## 2. 实体关系概览
- users 1..N reservations（预约发起人）
- users 1..N courses（教师创建课程）
- labs 1..N devices
- labs 1..N reservations
- devices 0..N reservations
- courses 0..N reservations
- reservation_series 1..N reservation_series_items
- reservations 1..N approvals
- users 1..N approvals（审批人）
- users 1..N audit_logs（操作人）
- users 1..N notifications

## 3. 表结构设计

### 3.1 users（用户）
字段
- id BIGINT PK AUTO_INCREMENT
- name VARCHAR(64) NOT NULL
- email VARCHAR(128) UNIQUE NULL
- phone VARCHAR(32) UNIQUE NULL
- role VARCHAR(16) NOT NULL  -- ADMIN/TEACHER/STUDENT
- status VARCHAR(16) NOT NULL DEFAULT 'ACTIVE'  -- ACTIVE/DISABLED
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

索引
- uq_users_email (email)
- uq_users_phone (phone)
- idx_users_role (role)

备注
- 认证信息由 OAuth2 资源服务器或外部身份源管理时，此表仅保存业务用户信息。

### 3.2 labs（实验室）
字段
- id BIGINT PK AUTO_INCREMENT
- name VARCHAR(128) NOT NULL
- location VARCHAR(128) NOT NULL
- capacity INT NOT NULL
- open_time_start TIME NOT NULL
- open_time_end TIME NOT NULL
- status VARCHAR(16) NOT NULL DEFAULT 'IDLE'  -- IDLE/RESERVED/IN_USE/MAINTENANCE/DISABLED
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

索引
- uq_labs_name (name)
- idx_labs_status (status)

### 3.3 devices（设备）
字段
- id BIGINT PK AUTO_INCREMENT
- lab_id BIGINT NOT NULL
- name VARCHAR(128) NOT NULL
- model VARCHAR(128) NULL
- status VARCHAR(16) NOT NULL DEFAULT 'IDLE'  -- IDLE/RESERVED/IN_USE/MAINTENANCE/RETIRED
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK devices.lab_id -> labs.id

索引
- idx_devices_lab_id (lab_id)
- idx_devices_status (status)

### 3.4 courses（课程）
字段
- id BIGINT PK AUTO_INCREMENT
- name VARCHAR(128) NOT NULL
- class_name VARCHAR(128) NOT NULL
- student_count INT NOT NULL
- term VARCHAR(64) NOT NULL
- created_by BIGINT NOT NULL  -- teacher_id
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK courses.created_by -> users.id

索引
- idx_courses_created_by (created_by)
- idx_courses_term (term)

### 3.5 reservations（预约）
字段
- id BIGINT PK AUTO_INCREMENT
- requester_id BIGINT NOT NULL
- lab_id BIGINT NOT NULL
- device_id BIGINT NULL
- course_id BIGINT NULL
- start_time DATETIME NOT NULL
- end_time DATETIME NOT NULL
- status VARCHAR(16) NOT NULL  -- PENDING/APPROVED/REJECTED/CANCELLED/EXPIRED/IN_USE/COMPLETED
- type VARCHAR(16) NOT NULL  -- SINGLE/RECURRING/COURSE
- priority VARCHAR(16) NOT NULL DEFAULT 'NORMAL'  -- NORMAL/COURSE
- approved_by BIGINT NULL
- approved_at DATETIME NULL
- cancel_reason VARCHAR(255) NULL
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK reservations.requester_id -> users.id
- FK reservations.lab_id -> labs.id
- FK reservations.device_id -> devices.id
- FK reservations.course_id -> courses.id
- FK reservations.approved_by -> users.id
- CHECK (start_time < end_time)

索引（冲突检测关键）
- idx_reservations_lab_time (lab_id, start_time, end_time)
- idx_reservations_device_time (device_id, start_time, end_time)
- idx_reservations_status (status)
- idx_reservations_requester (requester_id)
- idx_reservations_course (course_id)

备注
- 冲突检测通过范围查询实现，业务层保证维护状态与重叠规则。

### 3.6 reservation_series（多次预约批次）
字段
- id BIGINT PK AUTO_INCREMENT
- requester_id BIGINT NOT NULL
- rule_type VARCHAR(16) NOT NULL  -- DAILY/WEEKLY/CUSTOM
- rule_value JSON NOT NULL  -- 周几、间隔、次数等
- mode VARCHAR(16) NOT NULL  -- STRICT/PARTIAL
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK reservation_series.requester_id -> users.id

索引
- idx_reservation_series_requester (requester_id)

### 3.7 reservation_series_items（多次预约明细）
字段
- id BIGINT PK AUTO_INCREMENT
- series_id BIGINT NOT NULL
- reservation_id BIGINT NOT NULL
- status VARCHAR(16) NOT NULL
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK reservation_series_items.series_id -> reservation_series.id
- FK reservation_series_items.reservation_id -> reservations.id

索引
- idx_series_items_series_id (series_id)
- idx_series_items_reservation_id (reservation_id)

### 3.8 approvals（审批记录）
字段
- id BIGINT PK AUTO_INCREMENT
- reservation_id BIGINT NOT NULL
- action VARCHAR(16) NOT NULL  -- APPROVE/REJECT/OVERRIDE
- reason VARCHAR(255) NULL
- operator_id BIGINT NOT NULL
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK approvals.reservation_id -> reservations.id
- FK approvals.operator_id -> users.id

索引
- idx_approvals_reservation_id (reservation_id)
- idx_approvals_operator_id (operator_id)

### 3.9 audit_logs（审计日志）
字段
- id BIGINT PK AUTO_INCREMENT
- actor_id BIGINT NOT NULL
- action VARCHAR(64) NOT NULL
- target_type VARCHAR(32) NOT NULL
- target_id BIGINT NOT NULL
- detail JSON NULL
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK audit_logs.actor_id -> users.id

索引
- idx_audit_logs_actor_id (actor_id)
- idx_audit_logs_target (target_type, target_id)

### 3.10 notifications（通知）
字段
- id BIGINT PK AUTO_INCREMENT
- user_id BIGINT NOT NULL
- type VARCHAR(32) NOT NULL
- content VARCHAR(512) NOT NULL
- status VARCHAR(16) NOT NULL DEFAULT 'UNREAD'  -- UNREAD/READ
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

约束
- FK notifications.user_id -> users.id

索引
- idx_notifications_user_id (user_id)
- idx_notifications_status (status)

### 3.11 rule_configs（规则配置，预留扩展）
字段
- id BIGINT PK AUTO_INCREMENT
- key_name VARCHAR(64) NOT NULL
- value JSON NOT NULL
- description VARCHAR(255) NULL
- is_deleted TINYINT NOT NULL DEFAULT 0
- created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
- updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

索引
- uq_rule_configs_key (key_name)

## 4. 关键查询与索引说明
### 4.1 冲突检测
- 查询同一实验室的冲突：
  - WHERE lab_id = ? AND start_time < :end AND end_time > :start
- 查询同一设备的冲突：
  - WHERE device_id = ? AND start_time < :end AND end_time > :start
- 依赖索引：idx_reservations_lab_time、idx_reservations_device_time。

### 4.2 预约列表过滤
- 按用户、状态、时间范围查询：
  - WHERE requester_id = ? AND status IN (...) AND start_time >= ? AND end_time <= ?
- 依赖索引：idx_reservations_requester、idx_reservations_status。

## 5. 约束与一致性策略
- 业务层保证状态机迁移合法。
- 课程预约覆盖普通预约：课程预约进入待审，管理员确认后覆盖并通知。
- 设备级预约需审批；实验室级普通预约自动通过。
- 取消/修改时间窗：教师 ≥ 12 小时，学生 ≥ 24 小时。
- 资源维护/停用状态不得创建预约（业务层拦截）。

## 6. 数据字典（状态枚举）
- labs.status: IDLE/RESERVED/IN_USE/MAINTENANCE/DISABLED
- devices.status: IDLE/RESERVED/IN_USE/MAINTENANCE/RETIRED
- reservations.status: PENDING/APPROVED/REJECTED/CANCELLED/EXPIRED/IN_USE/COMPLETED
- reservations.type: SINGLE/RECURRING/COURSE
- reservations.priority: NORMAL/COURSE
- approvals.action: APPROVE/REJECT/OVERRIDE
- notifications.status: UNREAD/READ
- users.role: ADMIN/TEACHER/STUDENT
- users.status: ACTIVE/DISABLED
- reservation_series.rule_type: DAILY/WEEKLY/CUSTOM
- reservation_series.mode: STRICT/PARTIAL

## 7. 初始化与迁移建议
- 优先使用 Flyway 或 Liquibase 管理迁移。
- 建议预置 role 与基础规则配置（rule_configs）。
