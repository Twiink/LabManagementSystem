# 实验室管理系统后端项目文档

## 一、项目概述

### 1.1 项目简介

实验室管理系统后端是一个基于 Spring Boot 3.4.1 构建的 RESTful API 服务，为实验室管理系统前端提供数据支持。系统支持三种角色（学生、教师、管理员）的认证授权、实验室/设备管理、预约管理、课程管理等功能。

### 1.2 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 3.4.1 | 后端框架 |
| Java | 17 | 开发语言 |
| MyBatis | 3.0.5 | ORM框架 |
| Spring Security OAuth2 | 6.x | 安全认证 |
| MySQL | 8.x | 数据库 |
| Maven | - | 构建工具 |

### 1.3 项目架构

```
LabManagementSystemBackend/
├── pom.xml                    # Maven 配置
├── src/main/
│   ├── java/com/example/labmanagementsystembackend/
│   │   ├── LabManagementSystemBackendApplication.java  # 启动类
│   │   ├── common/            # 公共模块
│   │   │   ├── api/           # 统一响应封装
│   │   │   ├── error/         # 异常处理
│   │   │   └── util/          # 工具类
│   │   ├── config/            # 配置类
│   │   ├── controller/        # 控制器层
│   │   ├── domain/entity/     # 实体类
│   │   ├── dto/               # 数据传输对象
│   │   │   ├── request/       # 请求 DTO
│   │   │   └── response/      # 响应 DTO
│   │   ├── mapper/            # MyBatis Mapper
│   │   ├── service/           # 服务层
│   │   └── scheduler/         # 定时任务
│   └── resources/
│       ├── application.properties  # 应用配置
│       └── mapper/            # MyBatis XML 映射文件
```

---

## 二、核心文件详解

### 2.1 启动类

#### 2.1.1 LabManagementSystemBackendApplication.java

**路径**: `src/main/java/com/example/labmanagementsystembackend/LabManagementSystemBackendApplication.java`

**功能**: Spring Boot 应用入口类

```java
@SpringBootApplication
@EnableScheduling  // 启用定时任务功能
public class LabManagementSystemBackendApplication {
    public static void main(String[] args) {
        SpringApplication.run(LabManagementSystemBackendApplication.class, args);
    }
}
```

**设计要点**:
- `@EnableScheduling`: 启用定时任务调度，用于处理预约过期、签到超时等定时任务
- 标准 Spring Boot 启动入口，无任何额外配置

---

### 2.2 公共模块 (common/)

#### 2.2.1 统一响应封装 (api/)

**ApiResponse.java** - 统一 API 响应格式

```java
public class ApiResponse<T> {
    private final int code;        // 业务状态码：0 表示成功
    private final String message;  // 响应消息
    private final T data;          // 响应数据
    private final String requestId;// 请求追踪 ID

    // 成功响应
    public static <T> ApiResponse<T> success(T data, String requestId)

    // 失败响应
    public static <T> ApiResponse<T> failure(int code, String message, T data, String requestId)
}
```

**设计要点**:
- **code = 0**: 表示业务成功，非 0 值为业务错误码
- **requestId**: 用于请求追踪和日志关联
- **不可变对象**: 所有字段为 final，确保线程安全

**PageResponse.java** - 分页响应封装

```java
public class PageResponse<T> {
    private final List<T> items;   // 数据列表
    private final int page;        // 当前页码
    private final int pageSize;    // 每页大小
    private final long total;      // 总记录数
}
```

---

#### 2.2.2 错误处理 (error/)

**ErrorCode.java** - 业务错误码枚举

```java
public enum ErrorCode {
    RESERVATION_WINDOW_INVALID(4001, "预约时间窗不满足要求"),
    RESOURCE_CONFLICT(4002, "资源时间冲突"),
    RESOURCE_UNAVAILABLE(4003, "资源当前不可用"),
    QUOTA_EXCEEDED(4004, "已超出预约上限"),
    PERMISSION_DENIED(4005, "权限不足"),
    VALIDATION_FAILED(4006, "参数校验失败"),
    INVALID_STATE(4007, "当前预约状态不允许此操作"),
    APPROVAL_REQUIRED(4008, "审批流程要求未满足"),
    NOT_FOUND(4009, "请求的资源不存在"),
    UNAUTHORIZED(4010, "登录已失效"),
    INTERNAL_ERROR(5000, "内部服务器错误");

    private final int code;
    private final String message;
}
```

**BusinessException.java** - 业务异常

```java
public class BusinessException extends RuntimeException {
    private final ErrorCode errorCode;
    private final Object data;

    public BusinessException(ErrorCode errorCode, String message)
    public BusinessException(ErrorCode errorCode, String message, Object data)
}
```

**GlobalExceptionHandler.java** - 全局异常处理器

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    // 处理业务异常
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Object>> handleBusiness(...)

    // 处理权限异常
    @ExceptionHandler(AccessDeniedException.class)

    // 处理参数校验异常
    @ExceptionHandler({MethodArgumentNotValidException.class, ...})

    // 处理未捕获异常
    @ExceptionHandler(Exception.class)
}
```

**设计要点**:
- **@RestControllerAdvice**: 统一处理所有 Controller 的异常
- **ResponseEntity**: 可自定义 HTTP 状态码
- **请求追踪**: 从请求属性中获取 requestId 返回给前端

---

#### 2.2.3 工具类 (util/)

**PageUtil.java** - 分页工具

```java
public class PageUtil {
    // 规范化页码（最小为 1）
    public static int normalizePage(int page)

    // 规范化每页大小（限制范围）
    public static int normalizePageSize(int pageSize)

    // 计算 OFFSET
    public static int offset(int page, int pageSize)
}
```

**TimeUtil.java** - 时间处理工具

```java
public class TimeUtil {
    // UTC 转换
    public static LocalDateTime toUtcLocalDateTime(OffsetDateTime odt)
    public static OffsetDateTime fromUtcLocalDateTime(LocalDateTime ldt)

    // 获取本地时间
    public static LocalTime toLocalTime(LocalDateTime ldt)
}
```

**SecurityUtil.java** - JWT 安全工具

```java
public class SecurityUtil {
    // 从 JWT 中提取用户 ID
    public static Long getUserId(Jwt jwt)

    // 从 JWT 中提取角色
    public static String getRole(Jwt jwt)

    // 从 JWT 中提取用户名
    public static String getUsername(Jwt jwt)
}
```

---

### 2.3 配置类 (config/)

#### 2.3.1 SecurityConfig.java - Spring Security 配置

**核心配置**:

```java
@Configuration
@EnableMethodSecurity  // 启用方法级安全控制
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) {
        http
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            .csrf(csrf -> csrf.disable())           // 禁用 CSRF（JWT 无状态）
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/login", "/api/auth/register").permitAll()
                .anyRequest().authenticated())
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS))  // 无状态会话
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt.jwtAuthenticationConverter(jwtAuthenticationConverter())));
    }
}
```

**CORS 配置**:

```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    // 允许的前端源
    configuration.setAllowedOrigins(Arrays.asList(
        "http://localhost:5173",  // Vite 开发服务器
        "http://localhost:3000"
    ));
    // 允许的 HTTP 方法
    configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"));
    // 允许的请求头（包含 Authorization）
    configuration.setAllowedHeaders(Arrays.asList("Authorization", "Content-Type", ...));
    // 允许携带凭证
    configuration.setAllowCredentials(true);
    // 暴露的响应头
    configuration.setExposedHeaders(Arrays.asList("X-Request-Id"));
}
```

**JWT 配置**:

```java
@Bean
public JwtDecoder jwtDecoder(@Value("${app.security.jwt.secret}") String secret) {
    // 使用 HMAC-SHA256 算法解码 JWT
    SecretKey key = new SecretKeySpec(secret.getBytes(StandardCharsets.UTF_8), "HmacSHA256");
    return NimbusJwtDecoder.withSecretKey(key).macAlgorithm(MacAlgorithm.HS256).build();
}

@Bean
public JwtEncoder jwtEncoder(@Value("${app.security.jwt.secret}") String secret) {
    // 使用 Nimbus JOSE 库编码 JWT
    SecretKey key = new SecretKeySpec(secret.getBytes(StandardCharsets.UTF_8), "HmacSHA256");
    OctetSequenceKey jwk = new OctetSequenceKey.Builder(key)
        .keyID(UUID.randomUUID().toString())
        .algorithm(JWSAlgorithm.HS256)
        .build();
    return new NimbusJwtEncoder(new ImmutableJWKSet<>(new JWKSet(jwk)));
}
```

**JWT 认证转换器**:

```java
@Bean
public JwtAuthenticationConverter jwtAuthenticationConverter() {
    JwtAuthenticationConverter converter = new JwtAuthenticationConverter();
    converter.setJwtGrantedAuthoritiesConverter(jwt -> {
        String role = jwt.getClaimAsString("role");
        if (role == null || role.isBlank()) {
            return List.of();
        }
        // 将角色转换为 Spring Security 权限格式
        return List.of(new SimpleGrantedAuthority("ROLE_" + role));
    });
    return converter;
}
```

**设计要点**:
- **无状态认证**: 不使用 Session，每个请求都携带 JWT
- **角色映射**: JWT 中的 `role` 字段自动映射为 `ROLE_XXX` 格式的权限
- **CORS 支持**: 配置允许前端开发服务器的跨域请求

---

#### 2.3.2 RequestIdFilter.java - 请求 ID 过滤器

**功能**: 为每个请求生成唯一 ID，用于链路追踪

```java
public class RequestIdFilter extends OncePerRequestFilter {
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) {
        // 从请求头获取或生成 requestId
        String requestId = request.getHeader("X-Request-Id");
        if (requestId == null) {
            requestId = UUID.randomUUID().toString();
        }
        // 设置到请求属性中，供后续使用
        request.setAttribute("requestId", requestId);
        // 设置到响应头，方便前端追踪
        response.setHeader("X-Request-Id", requestId);
        filterChain.doFilter(request, response);
    }
}
```

---

#### 2.3.3 WebConfig.java - Web 配置

**功能**: 注册过滤器、配置静态资源等

---

## 三、实体类 (domain/entity/)

### 3.1 核心实体

#### 3.1.1 User.java - 用户实体

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "name", nullable = false)
    private String name;           // 用户名

    @Column(name = "email")
    private String email;          // 邮箱

    @Column(name = "phone")
    private String phone;          // 电话

    @Column(name = "role", nullable = false)
    private String role;           // 角色: ADMIN / TEACHER / STUDENT

    @Column(name = "status", nullable = false)
    private String status;         // 状态: ACTIVE / DISABLED

    @Column(name = "password_hash")
    private String passwordHash;   // 密码哈希

    @Column(name = "is_deleted", nullable = false)
    private Integer isDeleted = 0; // 软删除标记

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

**设计要点**:
- **软删除**: 使用 `isDeleted` 标记，避免物理删除数据
- **密码安全**: 只存储密码哈希，不存储明文
- **审计字段**: 自动记录创建和更新时间

---

#### 3.1.2 Lab.java - 实验室实体

```java
@Entity
@Table(name = "labs")
public class Lab {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "name", nullable = false)
    private String name;           // 实验室名称

    @Column(name = "location", nullable = false)
    private String location;       // 位置

    @Column(name = "capacity", nullable = false)
    private Integer capacity;      // 容量

    @Column(name = "open_time_start", nullable = false)
    private LocalTime openTimeStart;  // 开放开始时间

    @Column(name = "open_time_end", nullable = false)
    private LocalTime openTimeEnd;    // 开放结束时间

    @Column(name = "status", nullable = false)
    private String status;         // 状态: IDLE / IN_USE / RESERVED / MAINTENANCE / DISABLED
}
```

---

#### 3.1.3 Device.java - 设备实体

```java
@Entity
@Table(name = "devices")
public class Device {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "lab_id", nullable = false)
    private Long labId;            // 所属实验室 ID

    @Column(name = "name", nullable = false)
    private String name;           // 设备名称

    @Column(name = "model")
    private String model;          // 型号

    @Column(name = "status", nullable = false)
    private String status;         // 状态: IDLE / IN_USE / RESERVED / MAINTENANCE / RETIRED
}
```

---

#### 3.1.4 Reservation.java - 预约实体

```java
@Entity
@Table(name = "reservations")
public class Reservation {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "requester_id", nullable = false)
    private Long requesterId;      // 申请人 ID

    @Transient
    private String requesterName;  // 申请人姓名（非数据库字段）

    @Column(name = "lab_id", nullable = false)
    private Long labId;            // 预约实验室 ID

    @Column(name = "device_id")
    private Long deviceId;         // 预约设备 ID（可选）

    @Column(name = "course_id")
    private Long courseId;         // 关联课程 ID（可选）

    @Column(name = "title")
    private String title;          // 预约事项

    @Column(name = "start_time", nullable = false)
    private LocalDateTime startTime;  // 开始时间

    @Column(name = "end_time", nullable = false)
    private LocalDateTime endTime;    // 结束时间

    @Column(name = "status", nullable = false)
    private String status;         // 状态: PENDING / APPROVED / REJECTED / CANCELLED / IN_USE / COMPLETED

    @Column(name = "type", nullable = false)
    private String type;           // 类型: SINGLE / RECURRING / COURSE

    @Column(name = "priority", nullable = false)
    private String priority;       // 优先级: NORMAL / COURSE

    @Column(name = "approved_by")
    private Long approvedBy;       // 审批人 ID

    @Column(name = "approved_at")
    private LocalDateTime approvedAt;  // 审批时间

    @Column(name = "cancel_reason")
    private String cancelReason;   // 取消原因
}
```

**预约状态流转**:

```
PENDING (待审批)
  ├── APPROVED (已通过) ───> IN_USE (使用中) ───> COMPLETED (已完成)
  └── REJECTED (已驳回)

CANCELLED (已取消) ─── 可从 PENDING 或 APPROVED 状态取消
```

**预约类型**:
- **SINGLE**: 单次预约
- **RECURRING**: 周期预约（批量预约）
- **COURSE**: 课程排课预约

---

#### 3.1.5 ReservationSeries.java - 周期预约规则实体

```java
@Entity
@Table(name = "reservation_series")
public class ReservationSeries {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "requester_id", nullable = false)
    private Long requesterId;      // 申请人

    @Column(name = "rule_type", nullable = false)
    private String ruleType;       // 规则类型: DAILY / WEEKLY / CUSTOM

    @Column(name = "rule_value", columnDefinition = "json")
    private String ruleValue;      // 规则值（JSON 格式）

    @Column(name = "mode", nullable = false)
    private String mode;           // 模式: LENIENT（宽松）/ STRICT（严格）
}
```

**规则类型**:
- **DAILY**: 每天重复（支持间隔天数）
- **WEEKLY**: 每周重复（支持选择周几）
- **CUSTOM**: 自定义日期列表

**模式**:
- **LENIENT**: 部分失败不影响其他预约
- **STRICT**: 任一预约失败则全部失败回滚

---

#### 3.1.6 ReservationSeriesItem.java - 周期预约项实体

```java
@Entity
@Table(name = "reservation_series_item")
public class ReservationSeriesItem {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "series_id")
    private Long seriesId;         // 关联的周期预约规则 ID

    @Column(name = "reservation_id")
    private Long reservationId;    // 实际的预约 ID

    @Column(name = "status")
    private String status;         // 预约状态
}
```

---

#### 3.1.7 Course.java - 课程实体

```java
@Entity
@Table(name = "courses")
public class Course {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "name", nullable = false)
    private String name;           // 课程名称

    @Column(name = "class_name")
    private String className;      // 班级名称

    @Column(name = "student_count")
    private Integer studentCount;  // 学生人数

    @Column(name = "term", nullable = false)
    private String term;           // 学期

    @Column(name = "lab_id")
    private Long labId;            // 关联实验室 ID

    @Column(name = "schedule_time")
    private String scheduleTime;   // 上课时间

    @Column(name = "created_by", nullable = false)
    private Long createdBy;        // 创建人（教师）
}
```

---

#### 3.1.8 CourseStudent.java - 课程学生关联实体

```java
@Entity
@Table(name = "course_student")
public class CourseStudent {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "course_id")
    private Long courseId;         // 课程 ID

    @Column(name = "student_id")
    private Long studentId;        // 学生 ID
}
```

---

#### 3.1.9 Approval.java - 审批记录实体

```java
@Entity
@Table(name = "approvals")
public class Approval {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "reservation_id")
    private Long reservationId;    // 关联预约 ID

    @Column(name = "action")
    private String action;         // 动作: APPROVE / REJECT / OVERRIDE

    @Column(name = "reason")
    private String reason;         // 原因/备注

    @Column(name = "operator_id")
    private Long operatorId;       // 操作人 ID
}
```

---

#### 3.1.10 AuditLog.java - 审计日志实体

```java
@Entity
@Table(name = "audit_logs")
public class AuditLog {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "actor_id")
    private Long actorId;          // 操作人 ID

    @Transient
    private String actorName;      // 操作人姓名（非数据库字段）

    @Column(name = "action")
    private String action;         // 操作类型

    @Column(name = "target_type")
    private String targetType;     // 目标类型

    @Column(name = "target_id")
    private Long targetId;         // 目标 ID

    @Column(name = "detail", columnDefinition = "json")
    private String detail;         // 详情（JSON 格式）
}
```

**操作类型**:
- **CREATE**: 创建
- **UPDATE**: 更新
- **DELETE**: 删除
- **RESET_PASSWORD**: 重置密码
- **RESERVATION_CREATE**: 创建预约
- **RESERVATION_APPROVE**: 审批通过
- **RESERVATION_REJECT**: 审批拒绝
- **RESERVATION_CANCEL**: 取消预约
- **RESERVATION_CHECKIN**: 签到
- **RESERVATION_CHECKOUT**: 签出
- **RESERVATION_OVERRIDE**: 覆盖预约

---

#### 3.1.11 Notification.java - 通知实体

```java
@Entity
@Table(name = "notifications")
public class Notification {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "user_id")
    private Long userId;           // 接收用户 ID

    @Column(name = "type")
    private String type;           // 通知类型

    @Column(name = "content")
    private String content;        // 通知内容

    @Column(name = "is_read", nullable = false)
    private Integer isRead = 0;    // 是否已读

    @Column(name = "created_at")
    private LocalDateTime createdAt;
}
```

---

#### 3.1.12 RuleConfig.java - 规则配置实体

```java
@Entity
@Table(name = "rule_configs")
public class RuleConfig {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "config_key", nullable = false)
    private String configKey;      // 配置键

    @Column(name = "config_value", columnDefinition = "json")
    private String configValue;    // 配置值（JSON 格式）

    @Column(name = "description")
    private String description;    // 描述

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

---

## 四、数据传输对象 (dto/)

### 4.1 请求 DTO (request/)

| 文件 | 功能 |
|------|------|
| LoginRequest.java | 登录请求（用户名、密码、角色） |
| RegisterRequest.java | 注册请求（用户名、密码、邮箱、电话） |
| UserUpdateRequest.java | 用户更新请求 |
| LabCreateRequest.java | 创建实验室请求 |
| LabUpdateRequest.java | 更新实验室请求 |
| LabStatusUpdateRequest.java | 更新实验室状态请求 |
| DeviceCreateRequest.java | 创建设备请求 |
| DeviceUpdateRequest.java | 更新设备请求 |
| DeviceStatusUpdateRequest.java | 更新设备状态请求 |
| ReservationCreateRequest.java | 创建预约请求 |
| ReservationUpdateRequest.java | 更新预约请求 |
| ReservationSeriesRequest.java | 批量预约请求 |
| ReservationApprovalRequest.java | 审批请求（通过/驳回） |
| ReservationOverrideRequest.java | 覆盖预约请求 |
| CourseCreateRequest.java | 创建课程请求 |
| CourseUpdateRequest.java | 更新课程请求 |
| CourseReservationRequest.java | 课程排课预约请求 |
| RuleConfigUpdateRequest.java | 更新规则配置请求 |

### 4.2 响应 DTO (response/)

| 文件 | 功能 |
|------|------|
| LoginResponse.java | 登录响应（Token、用户信息） |
| UserResponse.java | 用户信息响应 |
| LabResponse.java | 实验室信息响应 |
| DeviceResponse.java | 设备信息响应 |
| ReservationResponse.java | 预约信息响应 |
| ReservationCreateResponse.java | 创建预约响应（ID、状态） |
| ReservationSeriesResponse.java | 批量预约响应（成功/失败列表） |
| CalendarItemResponse.java | 日历项响应 |
| ConflictDetail.java | 冲突详情 |
| CourseResponse.java | 课程信息响应 |
| NotificationResponse.java | 通知信息响应 |
| AuditLogResponse.java | 审计日志响应 |
| RuleConfigResponse.java | 规则配置响应 |

---

## 五、Mapper 层

### 5.1 Mapper 接口列表

| Mapper | 对应实体 | 核心方法 |
|--------|----------|----------|
| UserMapper | User | findById, findByName, findByEmail, insert, findUsers, updateUser |
| LabMapper | Lab | findById, findLabs, countLabs, insert, updateLab, updateStatus |
| DeviceMapper | Device | findById, findDevices, countDevices, insert, update, updateStatus |
| ReservationMapper | Reservation | findById, findReservations, findConflicts, insertReservation, updateReservationTime, updateReservationStatus |
| ReservationSeriesMapper | ReservationSeries | insertSeries, findById |
| ReservationSeriesItemMapper | ReservationSeriesItem | insertItem, findBySeriesId |
| ApprovalMapper | Approval | insertApproval, findByReservationId |
| CourseMapper | Course | findById, findCourses, insert, update, delete |
| CourseStudentMapper | CourseStudent | insert, delete, findByCourseId |
| NotificationMapper | Notification | insert, findByUserId, markAsRead |
| AuditLogMapper | AuditLog | insertLog, findLogs, countLogs |
| RuleConfigMapper | RuleConfig | findByKey, findAll, insert, update, delete |

### 5.2 Mapper 设计要点

1. **方法命名规范**: 使用 MyBatis 规范命名（find/insert/update/delete）
2. **分页支持**: 所有查询方法支持 offset 和 pageSize 参数
3. **软删除**: 查询时自动过滤 is_deleted = 0 的记录

---

## 六、服务层 (service/)

### 6.1 AuthService - 认证服务

**核心功能**:

```java
@Service
public class AuthService {
    // 用户登录
    public LoginResponse login(String username, String rawPassword, String role)

    // 用户注册（仅限学生）
    public UserResponse register(String username, String rawPassword, String email, String phone)
}
```

**登录流程**:
1. 根据用户名查找用户
2. 验证密码是否匹配
3. 验证角色是否匹配
4. 生成 JWT Token
5. 返回 Token 和用户信息

**JWT Token 包含的 claims**:
- `iss`: 发行者
- `iat`: 签发时间
- `exp`: 过期时间
- `sub`: 用户 ID
- `name`: 用户名
- `role`: 角色

---

### 6.2 UserService - 用户服务

**核心功能**:

```java
public UserResponse getUserById(Long id)
public List<UserResponse> listUsers(String role, String status, int page, int pageSize)
public UserResponse updateUser(Long actorId, Long id, UserUpdateRequest request)
public void resetPassword(Long actorId, Long id)  // 重置为 123456
```

---

### 6.3 LabService - 实验室服务

**核心功能**:

```java
public List<LabResponse> listLabs(String status, String keyword, int page, int pageSize)
public LabResponse createLab(Long actorId, LabCreateRequest request)
public LabResponse updateLab(Long actorId, Long id, LabUpdateRequest request)
public void updateStatus(Long actorId, Long id, String status)
```

---

### 6.4 DeviceService - 设备服务

**核心功能**:

```java
public List<DeviceResponse> listDevices(String status, Long labId, String keyword, int page, int pageSize)
public DeviceResponse createDevice(Long actorId, DeviceCreateRequest request)
public DeviceResponse updateDevice(Long actorId, Long id, DeviceUpdateRequest request)
public void updateStatus(Long actorId, Long id, String status)
```

---

### 6.5 ReservationService - 预约服务（核心）

**核心功能**:

```java
// 查询
public List<ReservationResponse> listReservations(...)
public ReservationResponse getReservation(Long id)
public List<CalendarItemResponse> calendar(Long labId, Long deviceId, OffsetDateTime from, OffsetDateTime to)

// 创建
public ReservationCreateResponse createReservation(Long requesterId, ReservationCreateRequest request)
public ReservationSeriesResponse createSeries(Long requesterId, ReservationSeriesRequest request)
public ReservationCreateResponse createCourseReservation(Long requesterId, CourseReservationRequest request)

// 更新
public ReservationResponse updateReservation(Long requesterId, Long id, ReservationUpdateRequest request)
public void cancelReservation(Long requesterId, Long reservationId, String reason, boolean isAdmin)

// 签到/签出
public void checkin(Long operatorId, Long reservationId)
public void checkout(Long operatorId, Long reservationId)

// 审批
public void approve(Long operatorId, Long reservationId, String reason)
public void reject(Long operatorId, Long reservationId, String reason)
public void override(Long operatorId, Long reservationId, String reason, String action)
```

**预约校验流程**:

```
1. validateTimeRange()      - 校验时间范围（开始 < 结束）
2. validateLab()            - 校验实验室存在且状态可用
3. validateDevice()         - 校验设备存在且状态可用
4. validateOpenTime()       - 校验是否在实验室开放时间内
5. ensureNoConflicts()      - 校验时间冲突
```

**权限校验**:

```java
// 取消/修改权限
validateModifyPermission():
  - 管理员: 可以修改任何预约
  - 普通用户: 只能修改自己的预约
  - 教师: 需提前 12 小时
  - 学生: 需提前 24 小时

// 签到/签出权限
validateOperationPermission():
  - 管理员: 可以操作任何预约
  - 普通用户: 只能操作自己的预约
```

**批量预约规则生成**:

```java
// DAILY: 每天重复
buildDailySlots(start, end, count, interval)

// WEEKLY: 每周重复（选择周几）
buildWeeklySlots(start, end, daysOfWeek, count)

// CUSTOM: 自定义日期列表
buildCustomSlots(start, end, dates)
```

---

### 6.6 CourseService - 课程服务

**核心功能**:

```java
public List<CourseResponse> listCourses(String term, Long studentId, Long createdBy, int page, int pageSize)
public CourseResponse createCourse(Long actorId, CourseCreateRequest request)
public CourseResponse updateCourse(Long actorId, Long id, CourseUpdateRequest request)
public void deleteCourse(Long actorId, Long id)
public void addStudent(Long actorId, Long courseId, Long studentId)
public void removeStudent(Long actorId, Long courseId, Long studentId)
```

---

### 6.7 AuditLogService - 审计日志服务

**核心功能**:

```java
// 记录审计日志
public void record(Long actorId, String action, String targetType, Long targetId, String detail)

// 查询审计日志
public List<AuditLogResponse> listLogs(Long actorId, String targetType, Long targetId,
                                        OffsetDateTime fromTime, OffsetDateTime toTime,
                                        int page, int pageSize)
```

**设计要点**:
- 所有 CRUD 操作都会自动记录审计日志
- 日志详情以 JSON 格式存储，便于后续分析

---

### 6.8 NotificationService - 通知服务

**核心功能**:

```java
public void notifyUser(Long userId, String type, String content)
public List<NotificationResponse> getNotifications(Long userId, int page, int pageSize)
public void markAsRead(Long userId, Long notificationId)
```

---

### 6.9 RuleConfigService - 规则配置服务

**核心功能**:

```java
public List<RuleConfigResponse> getAllConfigs()
public RuleConfigResponse updateConfig(Long actorId, String configKey, RuleConfigUpdateRequest request)
```

---

## 七、控制器层 (controller/)

### 7.1 BaseController - 控制器基类

```java
public abstract class BaseController {
    // 统一返回成功响应
    protected <T> ApiResponse<T> success(HttpServletRequest request, T data)
    protected <T> ApiResponse<PageResponse<T>> success(HttpServletRequest request, PageResponse<T> pageData)
}
```

**设计要点**:
- 所有 Controller 继承 BaseController
- 统一处理 requestId 和响应格式

---

### 7.2 控制器列表

| 控制器 | 路径 | 核心功能 |
|--------|------|----------|
| AuthController | /api/auth | 登录、注册 |
| UserController | /api/users | 用户管理、重置密码 |
| LabController | /api/labs | 实验室 CRUD、状态更新 |
| DeviceController | /api/devices | 设备 CRUD、状态更新 |
| ReservationController | /api/reservations | 预约 CRUD、审批、签到/签出 |
| CourseController | /api/courses | 课程 CRUD、学生管理 |
| CalendarController | /api/calendar | 日历事件查询 |
| NotificationController | /api/notifications | 通知查询、标记已读 |
| AuditLogController | /api/audit-logs | 审计日志查询 |
| RuleConfigController | /api/rule-configs | 规则配置管理 |

---

### 7.3 权限控制示例

```java
@RestController
@RequestMapping("/api/reservations")
public class ReservationController {

    // 任何认证用户都可访问
    @GetMapping
    public ApiResponse<PageResponse<ReservationResponse>> listReservations(...)

    // 登录用户可创建预约
    @PostMapping
    @PreAuthorize("hasAnyRole('TEACHER','STUDENT','ADMIN')")
    public ApiResponse<ReservationCreateResponse> createReservation(...)

    // 只有教师/管理员可审批
    @PostMapping("/{id}/approve")
    @PreAuthorize("hasAnyRole('ADMIN','TEACHER')")
    public ApiResponse<Void> approve(...)

    // 只有管理员可覆盖预约
    @PostMapping("/{id}/override")
    @PreAuthorize("hasRole('ADMIN')")
    public ApiResponse<Void> override(...)
}
```

---

## 八、定时任务 (scheduler/)

### 8.1 ReservationScheduler - 预约定时任务

```java
@Component
public class ReservationScheduler {

    @Scheduled(cron = "0 * * * * ?")  // 每分钟执行
    public void processExpiredReservations() {
        // 处理过期未签到的预约
        // 查找 APPROVED 状态且开始时间已过 30 分钟的预约
        // 自动标记为 CANCELLED 或发送通知
    }

    @Scheduled(cron = "0 * * * * ?")  // 每分钟执行
    public void processOverdueReservations() {
        // 处理超时未签出的预约
        // 查找 IN_USE 状态且结束时间已过的预约
        // 自动标记为 COMPLETED 或发送通知
    }

    @Scheduled(cron = "0 0 9 * * ?")  // 每天 9:00
    public void sendPendingApprovalReminders() {
        // 发送待审批提醒
        // 查找 PENDING 状态且创建时间超过 24 小时的预约
        // 通知管理员审批
    }
}
```

---

## 九、API 接口清单

### 9.1 认证模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| POST | /api/auth/login | 用户登录 | 公开 |
| POST | /api/auth/register | 学生注册 | 公开 |

### 9.2 用户模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/users/me | 获取当前用户 | 认证 |
| GET | /api/users | 用户列表 | 管理员 |
| GET | /api/users/students | 学生列表 | 教师/管理员 |
| PUT | /api/users/{id} | 更新用户 | 管理员 |
| POST | /api/users/{id}/reset-password | 重置密码 | 管理员 |

### 9.3 实验室模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/labs | 实验室列表 | 认证 |
| POST | /api/labs | 创建实验室 | 管理员 |
| GET | /api/labs/{id} | 获取实验室详情 | 认证 |
| PUT | /api/labs/{id} | 更新实验室 | 管理员 |
| PATCH | /api/labs/{id}/status | 更新状态 | 管理员 |

### 9.4 设备模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/devices | 设备列表 | 认证 |
| POST | /api/devices | 创建设备 | 管理员 |
| GET | /api/devices/{id} | 获取设备详情 | 认证 |
| PUT | /api/devices/{id} | 更新设备 | 管理员 |
| PATCH | /api/devices/{id}/status | 更新状态 | 管理员 |

### 9.5 预约模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/reservations | 预约列表 | 认证 |
| POST | /api/reservations | 创建单次预约 | 教师/学生 |
| POST | /api/reservations/series | 创建批量预约 | 教师/学生 |
| POST | /api/reservations/course | 创建课程预约 | 教师 |
| GET | /api/reservations/{id} | 获取预约详情 | 认证 |
| PUT | /api/reservations/{id} | 更新预约 | 预约人/管理员 |
| DELETE | /api/reservations/{id} | 取消预约 | 预约人/管理员 |
| POST | /api/reservations/{id}/approve | 审批通过 | 教师/管理员 |
| POST | /api/reservations/{id}/reject | 审批驳回 | 教师/管理员 |
| POST | /api/reservations/{id}/override | 覆盖预约 | 管理员 |
| POST | /api/reservations/{id}/checkin | 签到 | 预约人/管理员 |
| POST | /api/reservations/{id}/checkout | 签出 | 预约人/管理员 |

### 9.6 课程模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/courses | 课程列表 | 认证 |
| POST | /api/courses | 创建课程 | 教师/管理员 |
| GET | /api/courses/{id} | 获取课程详情 | 认证 |
| PUT | /api/courses/{id} | 更新课程 | 创建者/管理员 |
| DELETE | /api/courses/{id} | 删除课程 | 创建者/管理员 |
| POST | /api/courses/{id}/students | 添加学生 | 教师/管理员 |
| DELETE | /api/courses/{id}/students/{studentId} | 移除学生 | 教师/管理员 |

### 9.7 日历模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/calendar | 获取日历事件 | 认证 |

### 9.8 通知模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/notifications | 通知列表 | 认证 |
| POST | /api/notifications/{id}/read | 标记已读 | 认证 |

### 9.9 审计日志模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/audit-logs | 审计日志列表 | 管理员 |

### 9.10 规则配置模块

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | /api/rule-configs | 规则配置列表 | 管理员 |
| PUT | /api/rule-configs/{key} | 更新规则配置 | 管理员 |

---

## 十、设计亮点与最佳实践

### 10.1 架构设计

1. **分层清晰**: Controller → Service → Mapper，职责分明
2. **面向接口**: 所有 Service 和 Mapper 都是接口，便于测试和替换
3. **不可变对象**: ApiResponse 使用 final 字段，线程安全
4. **异常处理**: 统一使用 BusinessException，便于错误追踪

### 10.2 安全设计

1. **JWT 无状态认证**: 不使用 Session，支持分布式部署
2. **细粒度权限控制**: @PreAuthorize 实现方法级权限
3. **密码加密**: 使用 Spring Security 的 PasswordEncoder
4. **软删除**: 保护数据，防止误删

### 10.3 业务逻辑

1. **预约校验链**: 层层校验，确保数据有效性
2. **冲突检测**: 时间冲突检测，防止资源重复预约
3. **状态流转控制**: 严格的状态机，防止非法状态转换
4. **审计日志**: 记录所有操作，便于追溯

### 10.4 可扩展性

1. **规则配置化**: 预约规则通过配置管理，可动态调整
2. **定时任务: 可扩展的定时任务框架
3. **通知机制**: 可扩展的通知系统

---

## 十一、运行与构建

### 11.1 环境要求

- JDK 17+
- MySQL 8.x
- Maven 3.6+

### 11.2 配置说明

在 `application.properties` 中配置:

```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/lab_management
spring.datasource.username=root
spring.datasource.password=your_password

# JWT 配置
app.security.jwt.secret=your-256-bit-secret-key
app.security.jwt.issuer=lab-management-system
app.security.jwt.ttl-seconds=86400

# 分页默认配置
app.page.default-size=20
app.page.max-size=100
```

### 11.3 启动方式

```bash
# 开发模式
./mvnw spring-boot:run

# 打包
./mvnw package

# 运行jar包
java -jar target/LabManagementSystemBackend-0.0.1-SNAPSHOT.jar
```

---

## 十二、总结

本后端项目采用 Spring Boot 3 + MyBatis + Spring Security OAuth2 技术栈，实现了完整的实验室管理系统后端 API。

**核心亮点**:
1. **JWT 认证**: 无状态认证，支持分布式部署
2. **角色权限**: 三级角色体系，细粒度权限控制
3. **预约系统**: 支持单次预约、批量预约、课程预约多种模式
4. **冲突检测**: 完善的时间冲突检测机制
5. **审计日志**: 完整的操作记录，便于追溯

**可优化方向**:
1. 引入 Redis 缓存，提升查询性能
2. 添加接口限流，防止恶意请求
3. 完善单元测试和集成测试
4. 添加 API 文档（Swagger）
5. 引入消息队列，异步处理通知
