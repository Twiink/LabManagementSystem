# 智能实验室预约与设备管理系统 后端设计文档

> 基于《需求文档》整理，面向 Spring Boot + MyBatis + MySQL 的后端设计草案，覆盖核心模块、数据模型、接口与关键规则。

## 1. 目标与范围
- 目标：实现实验室/设备/预约/权限管理与复杂规则校验的后端服务。
- 范围：用户与权限、实验室管理、设备管理、预约管理、课程绑定、审核流、冲突检测、通知与审计。

## 2. 技术选型与架构
- 技术栈：Spring Boot 3.4.x、MyBatis 3.0.x、MySQL 8.x、Spring Security + OAuth2 Resource Server。
- 架构风格：单体分层（Controller / Service / Mapper / Domain）。
- 约定：RESTful API，JSON 交互；服务端统一时区（建议 UTC+8 或 UTC+0，统一落库）。

### 2.1 分层结构
- Controller：鉴权、入参校验、输出 DTO。
- Service：业务规则、状态机、冲突检测、权限校验。
- Mapper：持久层 CRUD + 复杂查询。
- Domain/DTO：实体与传输对象分离。
- 逻辑删除：所有表增加 `is_deleted` 字段（0/1），业务层默认过滤 `is_deleted=0`。

## 3. 核心模块划分
1) 权限与用户模块
- 角色：管理员、教师、学生。
- RBAC：资源与操作级别授权。

2) 实验室模块
- 实验室信息维护、状态维护、开放时间。

3) 设备模块
- 设备与实验室绑定关系、状态维护。

4) 预约模块
- 单次预约、多次预约、课程绑定预约。
- 冲突检测与规则校验。
- 预约修改、取消、审核流程。

5) 审计与通知模块
- 操作日志、审批记录、通知消息。

## 4. 数据模型设计（核心表）
> 以 MySQL 为目标，字段名可根据团队风格调整。

### 4.1 用户与权限
- users
  - id (PK)
  - name, email, phone
  - role (ADMIN/TEACHER/STUDENT)
  - status (ACTIVE/DISABLED)
  - is_deleted (0/1)
  - created_at, updated_at

- roles (可选，若使用配置型 RBAC)
- permissions (可选)
- role_permissions (可选)

### 4.2 实验室
- labs
  - id (PK)
  - name, location
  - capacity
  - open_time_start, open_time_end (如 08:00-22:00)
  - status (IDLE/RESERVED/IN_USE/MAINTENANCE/DISABLED)
  - is_deleted (0/1)
  - created_at, updated_at

### 4.3 设备
- devices
  - id (PK)
  - lab_id (FK -> labs.id)
  - name, model
  - status (IDLE/RESERVED/IN_USE/MAINTENANCE/RETIRED)
  - is_deleted (0/1)
  - created_at, updated_at

### 4.4 课程
- courses
  - id (PK)
  - name, class_name
  - student_count
  - term
  - created_by (teacher_id)
  - is_deleted (0/1)
  - created_at, updated_at

### 4.5 预约
- reservations
  - id (PK)
  - requester_id (user)
  - lab_id
  - device_id (nullable)
  - course_id (nullable)
  - start_time, end_time
  - status (PENDING/APPROVED/REJECTED/CANCELLED/EXPIRED/IN_USE/COMPLETED)
  - type (SINGLE/RECURRING/COURSE)
  - priority (NORMAL/COURSE)
  - approved_by (admin_id, nullable)
  - approved_at, cancel_reason
  - is_deleted (0/1)
  - created_at, updated_at

- reservation_series（多次预约批次）
  - id (PK)
  - requester_id
  - rule_type (DAILY/WEEKLY/CUSTOM)
  - rule_value (例如周几、间隔等 JSON)
  - mode (STRICT/PARTIAL)
  - is_deleted (0/1)
  - created_at, updated_at

- reservation_series_items（多次预约明细）
  - id (PK)
  - series_id
  - reservation_id
  - status
  - is_deleted (0/1)
  - created_at, updated_at

### 4.6 审批与审计
- approvals
  - id (PK)
  - reservation_id
  - action (APPROVE/REJECT/OVERRIDE)
  - reason
  - operator_id
  - is_deleted (0/1)
  - created_at, updated_at

- audit_logs
  - id (PK)
  - actor_id
  - action
  - target_type, target_id
  - detail (JSON)
  - is_deleted (0/1)
  - created_at, updated_at

### 4.7 通知
- notifications
  - id (PK)
  - user_id
  - type
  - content
  - status (UNREAD/READ)
  - is_deleted (0/1)
  - created_at, updated_at

### 4.8 规则配置
- rule_configs
  - id (PK)
  - key_name
  - value (JSON)
  - description
  - is_deleted (0/1)
  - created_at, updated_at

## 5. 状态机设计
### 5.1 实验室状态
- IDLE -> RESERVED（预约成功）
- RESERVED -> IN_USE（签到或到达时间自动切换）
- RESERVED -> IDLE（预约取消/过期）
- IN_USE -> IDLE（使用结束）
- ANY -> MAINTENANCE（管理员设置维护）
- MAINTENANCE -> IDLE（维护完成）
- ANY -> DISABLED（管理员停用）

### 5.2 设备状态
- 与实验室一致，新增 RETIRED 终态。

### 5.3 预约状态
- PENDING -> APPROVED/REJECTED
- APPROVED -> IN_USE -> COMPLETED
- APPROVED -> CANCELLED/EXPIRED
- 管理员可强制 OVERRIDE 预约（记录审批/审计）。

## 6. 规则与冲突检测
### 6.1 冲突定义
- 同一实验室或设备在重叠时间段不可重复预约。
- MAINTENANCE/DISABLED/RETIRED 状态不可预约。
- 课程预约优先级高于普通预约（可配置）。

### 6.2 冲突检测算法
- 时间重叠：startA < endB 且 endA > startB。
- 多次预约：对每个候选时间段检测冲突。
- 数据库：使用范围查询与索引（lab_id/start_time/end_time）。

### 6.3 规则配置
- 预约提前时间、最晚取消时间。
- 每角色每日/每周预约上限。
- 课程预约优先级与抢占策略。

### 6.4 修改/取消规则
- 教师：开始前 ≥ 12 小时可改/取消。
- 学生：开始前 ≥ 24 小时可改/取消。
- 超时仅管理员可处理并填写原因。

## 7. 接口设计（示例）
> 仅列出核心 API，路径可根据路由风格调整。

### 7.1 认证与用户
- POST /api/auth/login
- GET /api/users/me
- GET /api/users (管理员)

### 7.2 实验室
- GET /api/labs
- POST /api/labs (管理员)
- PUT /api/labs/{id} (管理员)
- PATCH /api/labs/{id}/status (管理员)

### 7.3 设备
- GET /api/devices?labId=
- POST /api/devices (管理员)
- PUT /api/devices/{id} (管理员)
- PATCH /api/devices/{id}/status (管理员)

### 7.4 预约
- POST /api/reservations (单次)
- POST /api/reservations/series (多次预约)
- POST /api/reservations/course (课程预约)
- GET /api/reservations?labId=&deviceId=&status=&from=&to=
- PUT /api/reservations/{id}
- DELETE /api/reservations/{id}
- POST /api/reservations/{id}/approve (管理员)
- POST /api/reservations/{id}/reject (管理员)
- POST /api/reservations/{id}/override (管理员)

## 8. 关键流程
### 8.1 创建预约
1) 鉴权与角色校验
2) 校验开放时间、预约上限、时间窗
3) 冲突检测（实验室/设备/维护状态）
4) 生成预约记录（PENDING/APPROVED 视策略）
5) 写入审计与通知

### 8.2 多次预约
1) 生成候选时间段列表
2) 逐条冲突检测
3) STRICT：任一冲突则失败；PARTIAL：仅创建可用时段
4) 返回失败时段列表

### 8.3 课程预约
1) 校验课程信息
2) 以高优先级检测冲突
3) 若需覆盖普通预约：走管理员审批或自动调整

## 9. 权限与安全
- JWT 解析与资源服务器校验。
- 方法级别权限（如 @PreAuthorize）。
- 关键操作（审批/覆盖/停用）写审计日志。

## 10. 错误码与响应
- 统一错误响应格式：code/message/details。
- 示例：
  - 4001 预约时间窗不满足
  - 4002 资源冲突
  - 4003 资源维护中/停用
  - 4004 超出预约上限
  - 4005 权限不足

## 11. 可扩展性与运维
- 规则引擎：保留配置表（rule_configs）支持后续扩展。
- 日志：审计日志与业务日志分离。
- 监控：Spring Actuator（可选）。

## 12. 已确认方案
### 12.1 审核流策略
- 采用中等方案：课程预约与设备级预约需审批；实验室级普通预约自动通过。

### 12.2 课程预约覆盖普通预约
- 采用中等方案：课程预约进入待审，管理员确认后覆盖普通预约并通知。

### 12.3 时区与时间精度
- 采用中等方案：统一 UTC 入库与计算，前端展示转本地时区，精度到分钟。
