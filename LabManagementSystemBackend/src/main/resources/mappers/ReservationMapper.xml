<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.labmanagementsystembackend.mapper.ReservationMapper">

    <resultMap id="ReservationMap" type="com.example.labmanagementsystembackend.domain.entity.Reservation">
        <id column="id" property="id" />
        <result column="requester_id" property="requesterId" />
        <result column="lab_id" property="labId" />
        <result column="device_id" property="deviceId" />
        <result column="course_id" property="courseId" />
        <result column="start_time" property="startTime" />
        <result column="end_time" property="endTime" />
        <result column="status" property="status" />
        <result column="type" property="type" />
        <result column="priority" property="priority" />
        <result column="approved_by" property="approvedBy" />
        <result column="approved_at" property="approvedAt" />
        <result column="cancel_reason" property="cancelReason" />
        <result column="is_deleted" property="isDeleted" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <select id="findById" resultMap="ReservationMap">
        SELECT * FROM reservations WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="findReservations" resultMap="ReservationMap">
        SELECT * FROM reservations
        <where>
            AND is_deleted = 0
            <if test="labId != null">AND lab_id = #{labId}</if>
            <if test="deviceId != null">AND device_id = #{deviceId}</if>
            <if test="requesterId != null">AND requester_id = #{requesterId}</if>
            <if test="status != null and status.size() > 0">
                AND status IN
                <foreach collection="status" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="type != null and type != ''">AND type = #{type}</if>
            <if test="fromTime != null">AND start_time &gt;= #{fromTime}</if>
            <if test="toTime != null">AND end_time &lt;= #{toTime}</if>
        </where>
        ORDER BY start_time DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countReservations" resultType="long">
        SELECT COUNT(1) FROM reservations
        <where>
            AND is_deleted = 0
            <if test="labId != null">AND lab_id = #{labId}</if>
            <if test="deviceId != null">AND device_id = #{deviceId}</if>
            <if test="requesterId != null">AND requester_id = #{requesterId}</if>
            <if test="status != null and status.size() > 0">
                AND status IN
                <foreach collection="status" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="type != null and type != ''">AND type = #{type}</if>
            <if test="fromTime != null">AND start_time &gt;= #{fromTime}</if>
            <if test="toTime != null">AND end_time &lt;= #{toTime}</if>
        </where>
    </select>

    <insert id="insertReservation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reservations (requester_id, lab_id, device_id, course_id, start_time, end_time, status, type, priority, is_deleted)
        VALUES (#{requesterId}, #{labId}, #{deviceId}, #{courseId}, #{startTime}, #{endTime}, #{status}, #{type}, #{priority}, #{isDeleted})
    </insert>

    <update id="updateReservationTime">
        UPDATE reservations
        SET start_time = #{startTime},
            end_time = #{endTime}
        WHERE id = #{id}
    </update>

    <update id="updateReservationStatus">
        UPDATE reservations
        SET status = #{status},
            approved_by = #{approvedBy},
            approved_at = #{approvedAt},
            cancel_reason = #{cancelReason}
        WHERE id = #{id}
    </update>

    <!--
        冲突检测查询：
        规则：时间重叠 = startA < endB AND endA > startB
        条件：
        1. 同一实验室的预约
        2. 如果指定了设备，则还需检测同一设备的冲突
        3. 只检测有效状态的预约（PENDING/APPROVED/IN_USE）
        4. 排除已删除的记录
    -->
    <select id="findConflicts" resultMap="ReservationMap">
        SELECT * FROM reservations
        WHERE lab_id = #{labId}
          AND is_deleted = 0
          AND status IN ('PENDING', 'APPROVED', 'IN_USE')
          AND start_time &lt; #{endTime}
          AND end_time &gt; #{startTime}
          <if test="deviceId != null">
              AND (device_id IS NULL OR device_id = #{deviceId})
          </if>
          <if test="excludeId != null">AND id != #{excludeId}</if>
    </select>

    <select id="findCalendar" resultMap="ReservationMap">
        SELECT * FROM reservations
        WHERE start_time &lt;= #{toTime} AND end_time &gt;= #{fromTime}
        AND is_deleted = 0
        <if test="labId != null">AND lab_id = #{labId}</if>
        <if test="deviceId != null">AND device_id = #{deviceId}</if>
        ORDER BY start_time ASC
    </select>

    <!-- 查找过期未签到的预约：APPROVED 状态且开始时间已过阈值 -->
    <select id="findExpiredReservations" resultMap="ReservationMap">
        SELECT * FROM reservations
        WHERE status = 'APPROVED'
          AND start_time &lt; #{threshold}
          AND is_deleted = 0
        ORDER BY start_time ASC
    </select>

    <!-- 查找超时未签出的预约：IN_USE 状态且结束时间已过阈值 -->
    <select id="findOverdueReservations" resultMap="ReservationMap">
        SELECT * FROM reservations
        WHERE status = 'IN_USE'
          AND end_time &lt; #{threshold}
          AND is_deleted = 0
        ORDER BY end_time ASC
    </select>

    <!-- 查找长期未处理的待审批预约：PENDING 状态且创建时间已过阈值 -->
    <select id="findOldPendingReservations" resultMap="ReservationMap">
        SELECT * FROM reservations
        WHERE status = 'PENDING'
          AND created_at &lt; #{threshold}
          AND is_deleted = 0
        ORDER BY created_at ASC
    </select>
</mapper>
